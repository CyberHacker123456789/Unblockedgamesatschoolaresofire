<!DOCTYPE html>
<html>
<head>
    <title>Asteroid Hunter: Enhanced</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Courier New', Courier, monospace; color: white; }
        canvas { display: block; }
        #ui { position: absolute; top: 20px; left: 20px; font-size: 20px; pointer-events: none; text-shadow: 2px 2px black; z-index: 10; }
        .screen-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(0, 0, 0, 0.95); padding: 30px; border-radius: 10px; border: 2px solid #00ffcc; display: none; width: 80%; max-width: 500px; z-index: 100; }
        #settingsScreen { display: block; }
        h2 { color: #00ffcc; margin-top: 0; letter-spacing: 4px; }
        .control-group { margin: 15px 0; padding: 10px; border-bottom: 1px solid #333; text-align: left; }
        .control-label { display: block; margin-bottom: 10px; font-weight: bold; color: #aaa; font-size: 14px; }
        .color-option { width: 30px; height: 30px; border-radius: 50%; display: inline-block; margin-right: 10px; cursor: pointer; border: 3px solid transparent; }
        .color-option.selected { border: 3px solid white; }
        .switch { cursor: pointer; background: #222; padding: 8px 15px; border-radius: 5px; border: 1px solid #444; color: white; margin-right: 10px; font-family: inherit; }
        .switch.on { background: #004422; border-color: lime; color: lime; }
        .game-button { background: #00ffcc; color: black; border: none; padding: 15px 30px; font-size: 20px; cursor: pointer; margin-top: 20px; font-family: inherit; font-weight: bold; width: 100%; transition: 0.2s; }
        .game-button:hover { background: white; transform: scale(1.05); }
    </style>
</head>
<body>
    <div id="ui">
        SCORE: <span id="score">0</span> | BEST: <span id="highScore">0</span>
        <div id="health"></div>
        <div id="status" style="margin-top:10px; font-size: 14px;"></div>
    </div>

    <div id="settingsScreen" class="screen-container">
        <h2>MISSION CONTROL</h2>
        <div class="control-group">
            <span class="control-label">HULL PAINT</span>
            <div id="colorPicker">
                <span class="color-option selected" data-color="white" style="background-color: white;"></span>
                <span class="color-option" data-color="#00ff00" style="background-color: #00ff00;"></span>
                <span class="color-option" data-color="#00ffff" style="background-color: #00ffff;"></span>
                <span class="color-option" data-color="#ff00ff" style="background-color: #ff00ff;"></span>
            </div>
        </div>
        <div class="control-group">
            <span class="control-label">AVIONICS</span>
            <button id="soundToggle" class="switch on" onclick="toggleSound()">SOUND: ON</button>
            <button id="autoToggle" class="switch" onclick="toggleAuto()">AUTOSHOOT: OFF</button>
        </div>
        <button class="game-button" onclick="startGame()">IGNITION (Space)</button>
    </div>

    <div id="gameOver" class="screen-container">
        <h1 style="color: red;">TERMINATED</h1>
        <p>Final Score: <span id="finalScore">0</span></p>
        <button class="game-button" onclick="showSettings()">REBOOT</button>
    </div>
    <canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let score = 0, highScore = localStorage.getItem('astroHighScore') || 0;
    let lives = 3, gameRunning = false, asteroids = [], bullets = [], particles = [], powerups = [], keys = {};
    let shipColor = 'white', autoShoot = false, soundEnabled = true, lastShot = 0;
    let shieldActive = false, slowMoActive = 0, boostActive = 0;

    const ship = { x: canvas.width/2, y: canvas.height/2, r: 12, a: -Math.PI/2, xv: 0, yv: 0, thrust: 0.18, delay: 10 };
    document.getElementById('highScore').innerText = highScore;

    // --- AUDIO ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx; 
    function playSound(freq, duration, type='sine', vol=0.1) {
        if (!soundEnabled) return;
        if (!audioCtx) audioCtx = new AudioContext();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.type = type; osc.frequency.value = freq;
        osc.connect(g); g.connect(audioCtx.destination);
        g.gain.setValueAtTime(vol, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    }

    // --- UI HELPERS ---
    function toggleSound() { soundEnabled = !soundEnabled; const btn = document.getElementById('soundToggle'); btn.innerText = `SOUND: ${soundEnabled ? 'ON' : 'OFF'}`; btn.classList.toggle('on'); }
    function toggleAuto() { autoShoot = !autoShoot; const btn = document.getElementById('autoToggle'); btn.innerText = `AUTOSHOOT: ${autoShoot ? 'ON' : 'OFF'}`; btn.classList.toggle('on'); }
    document.querySelectorAll('.color-option').forEach(opt => {
        opt.onclick = () => {
            document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
            opt.classList.add('selected'); shipColor = opt.dataset.color;
        };
    });

    window.addEventListener('keydown', e => { keys[e.code] = true; if(e.code === 'Space' && !gameRunning) startGame(); });
    window.addEventListener('keyup', e => keys[e.code] = false);

    // --- GAME ENGINE ---
    function startGame() {
        document.getElementById('settingsScreen').style.display = 'none';
        document.getElementById('gameOver').style.display = 'none';
        score = 0; lives = 3; asteroids = []; bullets = []; powerups = []; 
        shieldActive = false; slowMoActive = 0; boostActive = 0;
        ship.x = canvas.width/2; ship.y = canvas.height/2; ship.xv = 0; ship.yv = 0;
        for(let i=0; i<5; i++) spawnAsteroid(true);
        gameRunning = true; update();
    }

    function spawnAsteroid(far=false) {
        let x, y;
        if(far) { x = Math.random()*canvas.width; y = Math.random()*canvas.height; }
        else { x = Math.random() < 0.5 ? -50 : canvas.width+50; y = Math.random()*canvas.height; }
        
        // Detailed jagged shape generation
        const corners = 8 + Math.floor(Math.random() * 7);
        const offsets = [];
        for(let i=0; i<corners; i++) offsets.push(Math.random() * 0.5 + 0.75);

        asteroids.push({ x, y, r: 30 + Math.random()*20, xv: (Math.random()-0.5)*3, yv: (Math.random()-0.5)*3, rot: Math.random()*Math.PI*2, rotV: (Math.random()-0.5)*0.02, corners, offsets });
    }

    function spawnPowerUp() {
        if (Math.random() < 0.003) {
            const types = ['shield', 'slowmo', 'boost'];
            powerups.push({ x: Math.random()*canvas.width, y: -20, yv: 1.5, type: types[Math.floor(Math.random()*3)], r: 15 });
        }
    }

    function showSettings() { gameRunning = false; document.getElementById('gameOver').style.display = 'none'; document.getElementById('settingsScreen').style.display = 'block'; }

    function update() {
        if (!gameRunning) return;
        ctx.fillStyle = '#050505'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        spawnPowerUp();

        // Ship Controls
        if (keys['ArrowLeft']) ship.a -= 0.08;
        if (keys['ArrowRight']) ship.a += 0.08;
        
        const currentThrust = boostActive > 0 ? ship.thrust * 2 : ship.thrust;
        if (keys['ArrowUp']) {
            ship.xv += currentThrust * Math.cos(ship.a);
            ship.yv += currentThrust * Math.sin(ship.a);
            
            // EXHAUST: Positioned exactly at the rear of the rocket
            const backX = ship.x - (ship.r * Math.cos(ship.a));
            const backY = ship.y - (ship.r * Math.sin(ship.a));
            particles.push({ x: backX, y: backY, xv: -ship.xv * 0.3 + (Math.random()-0.5), yv: -ship.yv * 0.3 + (Math.random()-0.5), life: 1.0, color: boostActive > 0 ? '#00ffff' : '#ffaa00' });
        }

        ship.x += ship.xv; ship.y += ship.yv;
        ship.xv *= 0.98; ship.yv *= 0.98;

        if (ship.x < 0) ship.x = canvas.width; if (ship.x > canvas.width) ship.x = 0;
        if (ship.y < 0) ship.y = canvas.height; if (ship.y > canvas.height) ship.y = 0;

        // Shooting
        if (lastShot > 0) lastShot--;
        const shootDelay = boostActive > 0 ? ship.delay / 2 : ship.delay;
        if ((autoShoot || keys['Space']) && lastShot <= 0) {
            bullets.push({ x: ship.x + ship.r * Math.cos(ship.a), y: ship.y + ship.r * Math.sin(ship.a), xv: 10 * Math.cos(ship.a), yv: 10 * Math.sin(ship.a), d: 0 });
            lastShot = shootDelay; playSound(600, 0.1, 'square', 0.05);
        }

        // Power-up Logic
        if (slowMoActive > 0) slowMoActive--;
        if (boostActive > 0) boostActive--;

        powerups.forEach((p, pi) => {
            p.y += p.yv;
            let pColor = p.type === 'shield' ? 'cyan' : p.type === 'slowmo' ? 'lime' : 'orange';
            ctx.shadowBlur = 15; ctx.shadowColor = pColor;
            ctx.fillStyle = pColor; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0;

            if (Math.hypot(p.x - ship.x, p.y - ship.y) < p.r + ship.r) {
                if (p.type === 'shield') shieldActive = true;
                if (p.type === 'slowmo') slowMoActive = 300;
                if (p.type === 'boost') boostActive = 300;
                powerups.splice(pi, 1); playSound(1000, 0.4, 'sine', 0.2);
            }
        });

        // Particles
        particles.forEach((p, i) => { 
            p.x += p.xv; p.y += p.yv; p.life -= 0.04; 
            if (p.life <= 0) particles.splice(i, 1); 
            else { ctx.fillStyle = p.color; ctx.globalAlpha = p.life; ctx.beginPath(); ctx.arc(p.x, p.y, 3 * p.life, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1; }
        });

        // Bullets
        bullets.forEach((b, i) => { b.x += b.xv; b.y += b.yv; b.d++; if (b.d > 50) bullets.splice(i, 1); else { ctx.fillStyle = '#00ffcc'; ctx.fillRect(b.x, b.y, 4, 4); } });

        // Asteroids
        const speedMod = slowMoActive > 0 ? 0.4 : 1;
        asteroids.forEach((a, ai) => {
            a.x += a.xv * speedMod; a.y += a.yv * speedMod; a.rot += a.rotV * speedMod;
            if (a.x < -50) a.x = canvas.width + 50; if (a.x > canvas.width + 50) a.x = -50;
            if (a.y < -50) a.y = canvas.height + 50; if (a.y > canvas.height + 50) a.y = -50;

            // DRAW JAGGED ASTEROID
            ctx.strokeStyle = '#888'; ctx.lineWidth = 2; ctx.beginPath();
            for(let i=0; i<a.corners; i++) {
                let ang = a.rot + (i * Math.PI * 2 / a.corners);
                let dist = a.r * a.offsets[i];
                ctx.lineTo(a.x + Math.cos(ang) * dist, a.y + Math.sin(ang) * dist);
            }
            ctx.closePath(); ctx.stroke();
            
            // Collisions
            bullets.forEach((b, bi) => {
                if (Math.hypot(a.x - b.x, a.y - b.y) < a.r) {
                    asteroids.splice(ai, 1); bullets.splice(bi, 1);
                    score += 100; playSound(150, 0.2, 'sawtooth'); spawnAsteroid();
                    document.getElementById('score').innerText = score;
                }
            });

            if (Math.hypot(a.x - ship.x, a.y - ship.y) < a.r + ship.r) {
                if (shieldActive) { shieldActive = false; asteroids.splice(ai, 1); spawnAsteroid(); playSound(500, 0.3); }
                else {
                    lives--; playSound(80, 0.6, 'sawtooth'); asteroids.splice(ai, 1); spawnAsteroid();
                    document.getElementById('health').innerHTML = "❤️".repeat(lives);
                    if (lives <= 0) {
                        gameRunning = false;
                        if (score > highScore) { highScore = score; localStorage.setItem('astroHighScore', highScore); }
                        document.getElementById('gameOver').style.display = 'block';
                        document.getElementById('finalScore').innerText = score;
                    }
                }
            }
        });

        // Status Text
        let status = [];
        if (shieldActive) status.push("<span style='color:cyan'>SHIELD ONLINE</span>");
        if (slowMoActive > 0) status.push("<span style='color:lime'>SLOW-MO ACTIVE</span>");
        if (boostActive > 0) status.push("<span style='color:orange'>OVERDRIVE ACTIVE</span>");
        document.getElementById('status').innerHTML = status.join("<br>");

        // Draw Ship
        ctx.save();
        ctx.translate(ship.x, ship.y);
        ctx.rotate(ship.a);
        
        if (shieldActive) {
            ctx.strokeStyle = 'cyan'; ctx.lineWidth = 2; ctx.setLineDash([5, 5]);
            ctx.beginPath(); ctx.arc(0, 0, ship.r + 12, 0, Math.PI*2); ctx.stroke();
            ctx.setLineDash([]);
        }

        ctx.strokeStyle = shipColor; ctx.lineWidth = 3; ctx.beginPath();
        ctx.moveTo(ship.r, 0); ctx.lineTo(-ship.r, -ship.r); ctx.lineTo(-ship.r*0.6, 0); ctx.lineTo(-ship.r, ship.r);
        ctx.closePath(); ctx.stroke();
        ctx.restore();

        requestAnimationFrame(update);
    }
</script>
</body>
</html>
